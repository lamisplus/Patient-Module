<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <property name="autoIncrement" value="true"/>

    <changeSet  failOnError="true" id="202220421-001" author="amos-data-fi">

        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_person"/>
            </not>
        </preConditions>

        <sql>
            CREATE TABLE patient_person
            (
                id                         BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_date               TIMESTAMP WITHOUT TIME ZONE,
                created_by                 VARCHAR(255),
                last_modified_date         TIMESTAMP WITHOUT TIME ZONE,
                last_modified_by           VARCHAR(255),
                active                     BOOLEAN,
                contact_point              JSONB,
                address                    JSONB,
                gender                     JSONB,
                identifier                 JSONB,
                deceased                   BOOLEAN,
                deceased_date_time         TIMESTAMP WITHOUT TIME ZONE,
                marital_status             JSONB,
                employment_status          JSONB,
                education                  JSONB,
                organization               JSONB,
                contact                    JSONB,
                date_of_birth              date,
                date_of_registration       date,
                archived                   INTEGER,
                facility_id                BIGINT,
                uuid                       VARCHAR(255) NOT NULL,
                nin_number                 VARCHAR(255),
                emr_id                     VARCHAR(255),
                first_name                 VARCHAR(255),
                sex                        VARCHAR(255),
                surname                    VARCHAR(255),
                other_name                 VARCHAR(255),
                hospital_number            VARCHAR(255),
                is_date_of_birth_estimated BOOLEAN,
                full_name                   VARCHAR(255),
                    CONSTRAINT pk_patient_person PRIMARY KEY (id)
            );
            ALTER TABLE patient_person
                ADD CONSTRAINT uc_patient_person_uuid UNIQUE (uuid);
        </sql>
    </changeSet>

    <changeSet failOnError="true"  id="20221705-002" author="amos-data-fi">

        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_visit"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE patient_visit
            (
                id                 BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_date       TIMESTAMP WITHOUT TIME ZONE,
                created_by         VARCHAR(255),
                last_modified_date TIMESTAMP WITHOUT TIME ZONE,
                last_modified_by   VARCHAR(255),
                facility_id        BIGINT,
                person_uuid        VARCHAR(255)                            NOT NULL,
                visit_start_date   TIMESTAMP WITHOUT TIME ZONE NOT NULL,
                visit_end_date     TIMESTAMP WITHOUT TIME ZONE,
                uuid               VARCHAR(255)                          NOT NULL,
                archived           INTEGER,
                CONSTRAINT pk_patient_visit PRIMARY KEY (id)
            );

            ALTER TABLE patient_visit
                ADD CONSTRAINT uc_patient_visit_uuid UNIQUE (uuid);

            ALTER TABLE patient_visit
                ADD CONSTRAINT FK_PATIENT_VISIT_ON_PERSON_UUID FOREIGN KEY (person_uuid) REFERENCES patient_person (uuid);
        </sql>
    </changeSet>

    <changeSet failOnError="true" id="20221705-004" author="amos-data-fi">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_encounter"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE patient_encounter
            (
                id                 BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                created_date       TIMESTAMP WITHOUT TIME ZONE,
                created_by         VARCHAR(255),
                last_modified_date TIMESTAMP WITHOUT TIME ZONE,
                last_modified_by   VARCHAR(255),
                facility_id        BIGINT,
                encounter_date     TIMESTAMP WITHOUT TIME ZONE NOT NULL,
                person_uuid        VARCHAR(255)                            NOT NULL,
                uuid               VARCHAR(255)                            NOT NULL,
                visit_id           VARCHAR(255)                            NOT NULL,
                service_code       VARCHAR(255)                            NOT NULL,
                status             VARCHAR(255)                            NOT NULL,
                archived           INTEGER,
                CONSTRAINT pk_patient_encounter PRIMARY KEY (id)
            );

            ALTER TABLE patient_encounter
                ADD CONSTRAINT uc_patient_encounter_uuid UNIQUE (uuid);

            ALTER TABLE patient_encounter
                ADD CONSTRAINT FK_PATIENT_ENCOUNTER_ON_PERSON_UUID FOREIGN KEY (person_uuid) REFERENCES patient_person (uuid);

            ALTER TABLE patient_encounter
                ADD CONSTRAINT FK_PATIENT_ENCOUNTER_ON_VISIT FOREIGN KEY (visit_id) REFERENCES patient_visit (uuid);
        </sql>
    </changeSet>
    <changeSet failOnError="true" id="20222005-005" author="amos-data-fi">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="patient_check_post_service"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE patient_check_post_service
            (
                id                  BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                facility_id         BIGINT,
                module_service_code VARCHAR(255),
                module_service_name VARCHAR(255),
                encounter_type      VARCHAR(255),
                CONSTRAINT pk_patient_check_post_service PRIMARY KEY (id)
            );
        </sql>
    </changeSet>
</databaseChangeLog>
